"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){e[r=void 0===r?n:r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,o,a,d){return new(a=a||Promise)(function(n,t){function r(e){try{s(d.next(e))}catch(e){t(e)}}function i(e){try{s(d.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?n(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(r,i)}s((d=d.apply(e,o||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.game_loop=void 0;const consts=__importStar(require("./constants")),query=__importStar(require("./queries")),h=__importStar(require("./helpers")),b=__importStar(require("neo-blessed")),i=__importStar(require("./interfaces")),tx=__importStar(require("./transactions")),fs=__importStar(require("fs")),update_dotenv_1=__importDefault(require("update-dotenv"));function play_ace(t){return __awaiter(this,void 0,void 0,function*(){for(;;){var e=yield h.get_input(consts.BOX);if("c"==e)return t;if("d"==e)return t+52;if("s"==e)return t+104;if("h"==e)return t+156;"Q"==e&&(yield h.exit(0,"you quit."))}})}function play_turn(u,_,f,y,p,g,m){return __awaiter(this,void 0,void 0,function*(){var e=yield query.hand_info(f,m.instance_id);e[1]||(yield h.exit(1,"failed to get hand data",e[0]));let t=e[0];"success"!==t.msg&&(yield h.show_alert("Invalid viewing key. Generate a new one in the settings menu."),yield consts.settings_menu(),e=yield query.hand_info(f,m.instance_id),"success"!==(t=e[0]).msg)&&h.exit(1,"error:\n",t);var n=u.status;h.generate_header(u,_,"{green-fg}it's your turn!{/}",y,p);let r=[...t.hand],i=[];for(var s=b.text({parent:consts.BOX,bottom:0,left:1,tags:!0,content:"enter an index, or (d)one, (r)eset, (Q)uit, (+) settings."});;){h.generate_table(u,m.index,i,r,g),consts.SCREEN.render();var o=yield h.get_input(consts.BOX);if("+"==o&&(yield consts.settings_menu()),"r"==o)r=[...t.hand],i=[];else{if("d"==o){s.setContent("sending..."),consts.SCREEN.render();var a=yield tx.send_tx(f,{play_turn:{cards:i,instance_id:m.instance_id}},[],55e3,0,!1);if("string"==typeof a){yield h.show_alert(a);continue}s.setContent("{green-fg}sent!{/}"),consts.SCREEN.render(),s.setContent("");break}"Q"==o&&(yield h.exit(0,"you quit."));a=parseInt(o);if(isNaN(a)||a>=r.length)s.setContent("{red-fg}Please enter a valid index, or (d)one, (r)eset, (Q)uit, (+) settings.{/}");else{let e=[];o=[...u.history];o.reverse();for(const c of o)if(c[0]<7||255==c[0]){e=c;break}var d,l,o=h.validate_card(r[a],i,e[1],n);o[0]?(d=r[a],0==h.translate_card(d)[1]?(s.setContent("choose a suit to request: (c)lubs (d)iamonds (s)pades (h)earts, (Q)uit, (+) settings."),consts.SCREEN.render(),l=yield play_ace(d),i.push(l)):i.push(d),0!=r.length&&r.splice(a,1),s.setContent("enter an index, or (d)one, (r)eset, (Q)uit.")):s.setContent("{red-fg}"+o[1]+"{/}")}}}s.destroy()})}function game_loop(m,v){return __awaiter(this,void 0,void 0,function*(){consts.BOX.setContent("");var e=b.text({parent:consts.BOX,top:0,left:1,tags:!0,content:""}),t=b.text({parent:consts.BOX,top:1,left:1,tags:!0,content:""}),n=b.listtable({parent:consts.BOX,top:3,left:1,height:"70%",align:"left",tags:!0}),r=yield query.allocation(m),s=(r[1]||(yield h.exit(1,"lost connection to game",r[0])),r[0]),r=s.index;(0,update_dotenv_1.default)({INSTANCE_ID:s.instance_id});let o="",a=255,d,l=[];var c=b.text({parent:consts.BOX,top:0,right:4,tags:!0,content:"timer text here"}),u=new h.Timer(m,s,c);for(u.begin();;){var _=yield query.game_info(m,s.instance_id,v);if(_[1]||(yield h.exit(1,"lost connection to game",_[0])),(d=_[0]).over){o=d.players[d.winner].username,a=d.winner;break}l=[];for(var f=d.history.length-1;0<=f;f--){var y=d.history[f];if(y[0]<7||255==y[0]){l=y;break}}var p,_=d.players[d.turn].username;d.turn==s.index?(consts.BOX.style.border.fg="#00FF00",consts.SCREEN.render(),yield h.sleep(.1),consts.BOX.style.border.fg="#F0F0F0",consts.SCREEN.render(),yield h.sleep(.1),consts.BOX.style.border.fg="#00FF00",consts.SCREEN.render(),yield h.sleep(.1),consts.BOX.style.border.fg="#F0F0F0",consts.SCREEN.render(),yield play_turn(d,l,m,e,t,n,s)):((p=yield query.hand_info(m,s.instance_id))[1]||(yield h.exit(1,"failed to fetch hand",p[0])),p=p[0],h.generate_header(d,l,"it's "+_+"'s turn",e,t),h.generate_table(d,s.index,[],p.hand,n),consts.SCREEN.render()),yield h.sleep(3)}if(u.stop(),consts.BOX.set("align","center"),a==r){e.destroy(),t.destroy(),n.destroy(),consts.BOX.setContent("{green-fg}you won!{/}\nclaim prize now? (Y/n)"),consts.SCREEN.render();u=yield h.get_input(consts.BOX);if("n"!=u&&"N"!=u){consts.BOX.setContent("claiming prize..."),consts.SCREEN.render();r=yield tx.send_tx(m,{claim_prize:{instance_id:s.instance_id}},[],66e3,0,!1);"string"==typeof r&&(yield h.show_alert(r),h.exit(1,"Could not perform claim tx, try again later, or await release."));let e=(new Date).toLocaleString("en-GB");e=(e=(e=(e=e.replace(/\//g,"-")).replace(/ /g,"-")).replace(/,/g,"-")).replace(/:/g,"-");u="./receipts",u=(fs.existsSync(u)||fs.mkdirSync(u),u+"/claim-prize-"+e),r=JSON.stringify(r);fs.writeFile(u,r,function(e){return __awaiter(this,void 0,void 0,function*(){e&&(yield h.exit(1,"failed to save receipt: ",e))})}),consts.BOX.setContent("{green-fg}sent!{/}\n receipt saved in file:\n"+u)}else consts.BOX.setContent("prize remains unclaimed.")}else{i.isGameInfo(d)||(yield h.exit(1,"lost connection to game",d)),l=[];for(f=d.history.length-1;0<=f;f--){var g=d.history[f];if(g[0]<7||255==g[0]){l=g;break}}h.generate_header(d,l,"winner was "+o,e,t),h.generate_table(d,s.index,[],[],n)}consts.SCREEN.render(),yield h.sleep(5),e.destroy(),t.destroy(),n.destroy(),c.destroy(),consts.BOX.setContent("winner was "+o+"\n\nback to menu? (Y/n)"),consts.SCREEN.render();r=yield h.get_input(consts.BOX);"n"!=r&&"N"!=r||h.exit(0,"game over")})}exports.game_loop=game_loop;