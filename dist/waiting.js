"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&("get"in i?t.__esModule:!i.writable&&!i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){e[r=void 0===r?n:r]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,a,s,l){return new(s=s||Promise)(function(n,t){function r(e){try{o(l.next(e))}catch(e){t(e)}}function i(e){try{o(l.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,i)}o((l=l.apply(e,a||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.wait_start=void 0;const consts=__importStar(require("./constants")),query=__importStar(require("./queries")),h=__importStar(require("./helpers")),b=__importStar(require("neo-blessed")),fs=__importStar(require("fs")),tx=__importStar(require("./transactions"));function wait_start(u){return __awaiter(this,void 0,void 0,function*(){consts.BOX.setContent("");let o=!1;var t=b.text({parent:consts.BOX,top:0,left:1,tags:!0,content:" waiting... ('l' to leave game)"}),n=b.text({parent:consts.BOX,top:3,left:1,tags:!0,content:""}),a=yield query.allocation(u);if(a[1]){let r=a[0].pool_id,i=b.box({parent:consts.SCREEN,top:"center",left:"center",width:"40%",height:"40%",align:"center",content:"leave game? y/N",tags:!0,padding:{left:2,right:2,top:1,bottom:1},border:{type:"line"},style:{border:{fg:"#f0f0f0"}},keys:!0,vi:!0,hidden:!0}),e=(consts.BOX.key("l",function(){return __awaiter(this,void 0,void 0,function*(){if(i.hidden=!i.hidden,!i.hidden){var t=yield h.get_input(i);if("y"==t||"Y"==t){i.content="leaving game...",consts.SCREEN.render();t=yield tx.send_tx(u,{leave_game:{pool_id:r}},[],55e3,0,!1);if("string"==typeof t)return void(yield h.show_alert(t));var n="./receipts";fs.existsSync(n)||fs.mkdirSync(n);let e=(new Date).toLocaleString("en-GB");n=n+"/refund-"+(e=(e=(e=(e=e.replace(/\//g,"-")).replace(/ /g,"-")).replace(/,/g,"-")).replace(/:/g,"-")),t=JSON.stringify(t,null,4);fs.writeFile(n,t,function(e){return __awaiter(this,void 0,void 0,function*(){e&&(yield h.exit(1,"failed to save receipt: ",e))})}),i.content="receipt saved in file:\n"+n,consts.SCREEN.render(),o=!0,yield h.sleep(5)}i.hidden=!0}consts.SCREEN.render()})}),255);for(;0!==e&&!o;){var s=yield query.allocation(u);if(s[1]||o){var l=s[0];if(consts.INFO_IN_A_QUEUE.test(l.instance_id))n.content="you are in the queue...",r=l.pool_id;else{s=yield query.game_info(u,l.instance_id,l.pool_id);if(!s[1])return!o;var c,d,s=s[0];e=h.capacity_by_pool_id(s.pool_id)-s.players.length;let t="players: ";for([c,d]of s.players.entries()){let e=d.username;c==l.index&&(e=`{blue-fg}${e}{/}`),t+=`
	`+e}n.content=`

waiting for ${e} more player`+(1==e?"\n\n":"s\n\n")+t}consts.SCREEN.render(),yield h.sleep(3)}}t.destroy(),n.destroy(),i.destroy(),consts.BOX.focus(),consts.BOX.unkey("enter",()=>{}),consts.SCREEN.render()}return!o})}exports.wait_start=wait_start;