"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var n=Object.getOwnPropertyDescriptor(t,r);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,n)}:function(e,t,r,s){e[s=void 0===s?r:s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,_,E,i){return new(E=E||Promise)(function(r,t){function s(e){try{o(i.next(e))}catch(e){t(e)}}function n(e){try{o(i.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?r(e.value):((t=e.value)instanceof E?t:new E(function(e){e(t)})).then(s,n)}o((i=i.apply(e,_||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.settings_menu=exports.ALERT=exports.BOX=exports.SCREEN=exports.SECRETCLI=exports.WALLET=exports.PATTERN_GAS_USED=exports.ERR_OUT_OF_GAS=exports.INFO_IN_A_QUEUE=exports.ERR_BANNED=exports.ERR_ALIAS_IS_IN_USE=exports.ERR_GAME_IS_HUMAN_ONLY=exports.ERR_GAME_IS_AI_ONLY=exports.ERR_PLAYER_ALREADY_JOINED=exports.ERR_POOL_NOT_FOUND=exports.ERR_GAME_IS_OVER=exports.ERR_ITEM_DOES_NOT_EXIST=exports.ERR_INSTANCE_IS_OFFLINE=exports.ERR_GENERIC=exports.GAS_LIMIT=exports.POOL_ID=exports.LUCKY_PHRASE=exports.AS_HUMAN=exports.INSTANCE_ID=exports.CODE_ID=exports.CONTRACT_ADDRESS=exports.BLACKJACK_VERSION=void 0,exports.BLACKJACK_VERSION="v0.0.0-alpha.rc.7",exports.CONTRACT_ADDRESS="secret1uxgy6zh4kxkzqevzf3hww3plsfcu4vm8e534y7",exports.CODE_ID=20271;const dotenv=__importStar(require("dotenv")),secretjs_1=(dotenv.config({override:!0}),exports.INSTANCE_ID=process.env.INSTANCE_ID,exports.AS_HUMAN="true"==process.env.AS_HUMAN,exports.LUCKY_PHRASE=process.env.LUCKY_PHRASE,exports.POOL_ID=process.env.POOL_ID,exports.GAS_LIMIT=process.env.GAS_LIMIT,exports.ERR_GENERIC=new RegExp("Generic error:"),exports.ERR_INSTANCE_IS_OFFLINE=new RegExp("Instance is offline."),exports.ERR_ITEM_DOES_NOT_EXIST=new RegExp("Item doesn't exist"),exports.ERR_GAME_IS_OVER=new RegExp("Game is over."),exports.ERR_POOL_NOT_FOUND=new RegExp("Pool not found"),exports.ERR_PLAYER_ALREADY_JOINED=new RegExp("Player has already joined as"),exports.ERR_GAME_IS_AI_ONLY=new RegExp("Game is AI only"),exports.ERR_GAME_IS_HUMAN_ONLY=new RegExp("Game is human only"),exports.ERR_ALIAS_IS_IN_USE=new RegExp("Alias is already in use."),exports.ERR_BANNED=new RegExp("Banned! \\:\\("),exports.INFO_IN_A_QUEUE=new RegExp("0{64}"),exports.ERR_OUT_OF_GAS=new RegExp("out of gas"),exports.PATTERN_GAS_USED=new RegExp("gasUsed:[' ']+([0-9]+):"),require("secretjs")),BLESSED=(exports.WALLET=new secretjs_1.Wallet(process.env.MNEMONIC),exports.SECRETCLI=[new secretjs_1.SecretNetworkClient({url:process.env.SECRET_LCD_URL_1,wallet:exports.WALLET,walletAddress:exports.WALLET.address,chainId:process.env.SECRET_CHAIN_ID}),new secretjs_1.SecretNetworkClient({url:process.env.SECRET_LCD_URL_2,wallet:exports.WALLET,walletAddress:exports.WALLET.address,chainId:process.env.SECRET_CHAIN_ID}),new secretjs_1.SecretNetworkClient({url:process.env.SECRET_LCD_URL_3,wallet:exports.WALLET,walletAddress:exports.WALLET.address,chainId:process.env.SECRET_CHAIN_ID})],__importStar(require("neo-blessed"))),helpers_1=(exports.SCREEN=BLESSED.screen({smartCSR:!0}),exports.SCREEN.title="Blackjack "+exports.BLACKJACK_VERSION,exports.SCREEN.key(["escape","C-c"],function(e,t){return exports.SCREEN.destroy(),process.exit(0)}),exports.BOX=BLESSED.box({parent:exports.SCREEN,top:"center",left:"center",width:100,height:"90%",content:"",tags:!0,padding:{left:4,right:4,top:3,bottom:3},border:{type:"line"},style:{border:{fg:"#f0f0f0"}},keys:!0,vi:!0,alwaysScroll:!0,scrollable:!0,scrollbar:{style:{bg:"yellow"}}}),exports.ALERT=BLESSED.box({parent:exports.SCREEN,top:"center",left:"center",width:"80%",height:"80%",align:"center",content:"",tags:!0,padding:{left:2,right:2,top:1,bottom:1},border:{type:"line"},style:{border:{fg:"#f0f0f0"}},keys:!0,vi:!0,hidden:!0}),require("./helpers")),queries_1=require("./queries"),fs=__importStar(require("fs")),update_dotenv_1=__importDefault(require("update-dotenv")),SETTINGS=BLESSED.box({parent:exports.SCREEN,top:"center",left:"center",width:90,height:"80%",align:"center",content:"",tags:!0,padding:{left:2,right:2,top:1,bottom:1},border:{type:"line"},style:{border:{fg:"#f0f0f0"}},keys:!0,vi:!0,hidden:!0});function settings_data(){return __awaiter(this,void 0,void 0,function*(){let e="none set";var t=yield(0,queries_1.name_of_addr)(process.env.CODE_HASH);return t[1]?e=t[0].username:exports.ERR_ITEM_DOES_NOT_EXIST.test(t[0])?e="none set":(e="could not get",yield(0,helpers_1.show_alert)("could not get username, is the viewing key correct?",t[0])),[["","","Settings"],["","",""],["{bold}index{/}","{bold}action{/}","{bold}current value{/}"],["","",""],["0)","generate viewing key",process.env.VIEWING_KEY],["1)","set username",e],["2)","toggle unicode symbols",process.env.SYMBOLIC_TERM]]})}const SETTINGS_TABLE=BLESSED.listtable({parent:SETTINGS,top:4,left:1,height:"70%",align:"left",tags:!0,data:[]});let SETTINGS_MESSAGE=BLESSED.text({parent:SETTINGS,top:1,left:1,tags:!0,content:"enter an index"});function generate_vk(){return __awaiter(this,void 0,void 0,function*(){let e="";var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=t.length;let s=0;for(;s<r;)e+=t.charAt(Math.floor(Math.random()*r)),s+=1;var n,o=yield exports.SECRETCLI[0].tx.compute.executeContract({sender:exports.WALLET.address,contract_address:exports.CONTRACT_ADDRESS,code_hash:process.env.CODE_HASH,msg:{set_viewing_key:{key:e}}},{gasLimit:5e4}).catch(e=>(0,helpers_1.show_alert)("generate viewing key failed: ",e));return o.arrayLog?(n=o.arrayLog[6].value,yield(0,update_dotenv_1.default)({VIEWING_KEY:n}),["",!0]):[o,!1]})}function set_username(){return __awaiter(this,void 0,void 0,function*(){var t=yield(0,queries_1.pool_info)(process.env.CODE_HASH,1);if(!t[1])return["could not fetch cost data",!1];var r=t[0].entry,t=t[0].denom;let e=String(r),s=String(t);"uscrt"==t&&(s="scrt",e=String(Number(r)/1e6)),SETTINGS_MESSAGE.setContent(`reserving a username costs ${e}${s}, proceed? (y/N)`),exports.SCREEN.render();var n=yield(0,helpers_1.get_input)(SETTINGS);if("y"!=n&&"Y"!=n)return["action cancelled",!1];SETTINGS_MESSAGE.setContent("{blue-fg}enter a username{/}"),exports.SCREEN.render();n=yield(0,helpers_1.get_input)(SETTINGS),SETTINGS_MESSAGE.setContent("setting username..."),exports.SCREEN.render(),r=yield exports.SECRETCLI[0].tx.compute.executeContract({sender:exports.WALLET.address,contract_address:exports.CONTRACT_ADDRESS,code_hash:process.env.CODE_HASH,msg:{set_username:{username:n}},sent_funds:[{amount:r,denom:t}]},{gasLimit:5e4}).catch(e=>(0,helpers_1.show_alert)("set username failed: ",e));if(r&&0==r.code){yield(0,update_dotenv_1.default)({USERNAME:n});t="./receipts";fs.existsSync(t)||fs.mkdirSync(t);let e=(new Date).toLocaleString("en-GB");n=t+"/username-buy-"+(e=(e=(e=(e=e.replace(/\//g,"-")).replace(/ /g,"-")).replace(/,/g,"-")).replace(/:/g,"-")),t=JSON.stringify(r,null,4);return fs.writeFile(n,t,function(e){return __awaiter(this,void 0,void 0,function*(){e&&(yield(0,helpers_1.exit)(1,"failed to save receipt: ",e))})}),yield(0,helpers_1.show_alert)("receipt saved in file:\n"+n),["",!0]}return[r,!1]})}function toggle_symbolic(){return __awaiter(this,void 0,void 0,function*(){let e="true";return"true"==process.env.SYMBOLIC_TERM&&(e="false"),yield(0,update_dotenv_1.default)({SYMBOLIC_TERM:e}),exports.SCREEN.render(),["",!0]})}const SETTINGS_MAP={};function settings_menu(){return __awaiter(this,void 0,void 0,function*(){if(SETTINGS.hidden=!SETTINGS.hidden,!SETTINGS.hidden){SETTINGS_TABLE.setData(yield settings_data()),SETTINGS.setFront(),exports.SCREEN.render();for(;;){var e,t=yield(0,helpers_1.get_input)(SETTINGS);if("q"===t)break;t in SETTINGS_MAP?(e=SETTINGS_MAP[t],SETTINGS_MESSAGE.setContent(`running '${SETTINGS_TABLE.rows[Number(t)+4][1]}'...`),exports.SCREEN.render(),(t=yield e())[1]?(SETTINGS_MESSAGE.setContent("{green-fg}done!{/} enter 'q' to quit settings."),SETTINGS_TABLE.setData(yield settings_data())):t[0].rawLog?SETTINGS_MESSAGE.setContent(t[0].rawLog):SETTINGS_MESSAGE.setContent("failed: "+t[0]),exports.SCREEN.render()):(SETTINGS_MESSAGE.setContent("not a valid setting index (enter 'q' to quit settings)"),exports.SCREEN.render())}SETTINGS.hidden=!0,SETTINGS.setBack()}exports.BOX.focus(),exports.SCREEN.render()})}SETTINGS_MAP[0]=generate_vk,SETTINGS_MAP[1]=set_username,SETTINGS_MAP[2]=toggle_symbolic,exports.settings_menu=settings_menu,exports.SCREEN.key(["+"],settings_menu);