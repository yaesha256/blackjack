"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,a)}:function(e,t,r,n){e[n=void 0===n?r:n]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__awaiter=this&&this.__awaiter||function(e,i,o,l){return new(o=o||Promise)(function(r,t){function n(e){try{s(l.next(e))}catch(e){t(e)}}function a(e){try{s(l.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(n,a)}s((l=l.apply(e,i||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.generate_pool_table=exports.validate_card=exports.generate_table=exports.generate_header=exports.translate_card=exports.exit=exports.sleep=exports.capacity_by_pool_id=exports.get_input=exports.show_alert=exports.Timer=void 0;const consts=__importStar(require("./constants")),update_dotenv_1=__importDefault(require("update-dotenv")),b=__importStar(require("neo-blessed")),query=__importStar(require("./queries"));class Timer{constructor(e,t,r){this.contractCodeHash=e,this.alloc=t,this.text_area=r,this.running=!0}begin(){return __awaiter(this,void 0,void 0,function*(){for(;this.running;){var t=yield query.game_info(this.contractCodeHash,this.alloc.instance_id,this.alloc.pool_id),t=(t[1]||(yield exit(1,"lost connection to game",t[0])),t[0]),t=Number(t.turn_ends_at)-Date.now()/1e3;if(t<0)return this.text_area.setContent("{red-fg}out of time{/}"),void consts.SCREEN.render();var r=Math.floor(t/60),t=Math.floor(t%60);let e=(0==r?`{red-fg}${r}m ${t}s{/}`:r+`m ${t}s`).padEnd(7);r==t&&0==t&&(e="{red-fg}out of time{/}"),this.text_area.setContent("time left: "+e),consts.SCREEN.render(),yield sleep(.5)}})}stop(){this.running=!1}}function shutdown(){return __awaiter(this,void 0,void 0,function*(){yield(0,update_dotenv_1.default)({POOL_ID:""}),yield(0,update_dotenv_1.default)({INSTANCE_ID:""}),consts.BOX.destroy(),consts.SCREEN.destroy()})}function show_alert(e,t=null){return __awaiter(this,void 0,void 0,function*(){null!==t&&(e+="\n\n"+JSON.stringify(t)),consts.ALERT.content=e+"\n\nPress enter to continue",consts.ALERT.hidden=!1,consts.ALERT.setFront(),consts.ALERT.focus(),consts.SCREEN.render(),yield get_input(consts.ALERT),consts.ALERT.content="",consts.ALERT.setBack(),consts.ALERT.hide(),consts.SCREEN.render()})}function get_input(e){var n=b.prompt({parent:e,height:1,width:40,bottom:5,left:0,tags:!0,keys:!0,vi:!0});return n.children[0].style.bg="",n.children[1].hidden=!0,n.children[2].hidden=!0,n.key(["escape","C-c"],function(){return __awaiter(this,void 0,void 0,function*(){yield exit(0,"exited")})}),new Promise(r=>n.input("","",(e,t)=>{n.destroy(),consts.SCREEN.render(),r(!e&&t?t:"")}))}function capacity_by_pool_id(e){let t=0;switch(e%3){case 0:t=2;break;case 1:t=4;break;case 2:t=7}return t}function sleep(t){return new Promise(e=>setTimeout(e,1e3*t))}function exit(e,t,r=null){return __awaiter(this,void 0,void 0,function*(){process.on("exit",function(){consts.SCREEN.destroy(),console.error(t),null!==r&&console.error(r)}),yield shutdown(),process.exit(e)})}function translate_card(e){var t=Math.floor(e/13);let r=0;return 0==t||4==t||8==t||12==t?r=0:1==t||5==t||9==t||13==t?r=1:2==t||6==t||10==t||14==t?r=2:3!=t&&7!=t&&11!=t&&15!=t||(r=3),[r,e%13]}function translate_card_print(e){var t="true"==process.env.SYMBOLIC_TERM,e=translate_card(e),r=e[0],e=e[1];let n="",a=(n=0==r?t?"♧":"cl".padEnd(2):1==r?"{red-fg}"+(t?"♢":"di".padEnd(2))+"{/}":2==r?t?"♤":"sp".padEnd(2):"{red-fg}"+(t?"♡":"he".padEnd(2))+"{/}","");return a=0==e?"ace":10==e?0==r||2==r?"{bold}jack{/}":"jack":11==e?"queen":12==e?"king":String(e+1),[n,a]}function generate_header(t,e,r,n,a){var s="true"==process.env.SYMBOLIC_TERM,i=t.status;n.setContent(r);let o="";if("p"==i[0]){n=parseInt(i.slice(2));o="status: {red-bg}{white-fg}pickup "+n+"{/}"+(t.reverse?" R":"  ")}else if("s"==i[0]){let e=i[2];e="0"==e?s?"♧":"cl":"1"==e?"{red-fg}"+(s?"♢":"di")+"{/}":"2"==e?s?"♤":"sp":"{red-fg}"+(s?"♡":"he")+"{/}",o="status: {blue-bg}{white-fg}suit "+e+"{/}"+(t.reverse?" R":"  ")}else o="status: normal"+(t.reverse?" R":"  ");r=255!=e[0]?t.players[e[0]].username:"game",n=translate_card_print(e[1]),i=n[0],t=n[1];o=o.padEnd(28)+" top card:{bold} '"+i.padEnd(s?1:2)+" "+t+"'{/} by "+r,a.setContent(o)}function generate_table(n,a,t,e,r){var s=consts.BOX.height,i="true"==process.env.SYMBOLIC_TERM,o=[["{blue-fg}your hand{/}".padEnd(25),"{green-fg}chain{/}".padEnd(25),"  player".padEnd(15),"n-cards","H/B","card history".padEnd(25)],["","","","","",""]];for(let r=0;r<s;r++){var l=[];if(r<e.length?(d=translate_card_print(e[r]),d=r+") "+d[0].padEnd(i?1:2)+" "+d[1],l.push(d)):l.push(""),r<t.length){var d=translate_card_print(t[r]);let e="";if("ace"==d[1]){var u=t[r];switch(Math.floor(u/52)){case 0:e="c";break;case 1:e="d";break;case 2:e="s";break;case 3:e="h"}}u=d[0].padEnd(i?1:2)+" "+d[1]+(e?" ("+e+")":"");l.push(u)}else l.push("");if(r<n.players.length?(h=(h=(p=n.players[r]).n_cards)<3?"{red-fg}"+String(h)+"{/}":String(h),c=r==n.turn?n.reverse?"^ ":"⌄ ":"  ",l.push(c+p.username),l.push(h),l.push(p.is_human?"H":"B")):(l.push(""),l.push(""),l.push("")),r<n.history.length){var c=n.history[n.history.length-(1+r)];let e=c[0];var p,_,h=c[1];let t="";t=255!=e&&6<e?"pickup "+h+" by "+((e-=7)===a?"{blue-fg}you{/}":n.players[e].username):(p=255==e?"game":e===a?"{blue-fg}you{/}":n.players[e].username,"play "+(_=translate_card_print(h))[0].padEnd(i?1:2)+" "+_[1]+" by "+p),l.push(t)}else l.push("");o.push(l)}r.setData(o)}function validate_card(e,t,r,n){if(0==t.length)if("p"==n[0]){var a=parseInt(n[2]),a=1+9*(Number(14==a)||+Number(7==a));if(translate_card(e)[1]!=a)return[!1,"invalid card with  pickup status"]}else if("s"==n[0]){a=parseInt(n[2]),n=translate_card(e);if(0!=n[1]&&n[0]!=a)return[!1,"invalid card with suit status"]}else{n=translate_card(r),a=translate_card(e);if(n[0]!=a[0]&&n[1]!=a[1])return[!1,"not a suitable card"]}else{r=translate_card(t[t.length-1]),n=translate_card(e);if(!(n[0]==r[0]&&Math.abs(n[1]-r[1])<2||n[1]==r[1]||11==r[1]&&r[0]==n[0]))return[!1,"not a valid chainable card"]}return[!0,""]}function generate_pool_table(e,u,t,c){return __awaiter(this,void 0,void 0,function*(){for(let a=u;a<t;a++){var s=[a+")"],i=yield query.pool_info(e,a);if(i[1]){i=i[0];let t="";if(i.online){var o=i.live_insts.length,l=i.inactive_insts.length,d=i.queue_len,l=Math.floor(o/(l+o)*100);let e="{red-fg}";l<50?e="{green-fg}":l<75&&(e="{yellow-fg}");o=0==d?"{green-fg}no queue{/}":"in queue: "+d;t=""+e+(String(l)+"%").padEnd(5)+"{/}"+o}else t="{red-fg}offline{/}";s.push(t.padEnd(5)),255!=i.n_players?s.push(i.n_players+"/"+i.player_cap):s.push("-");let e=parseInt(i.entry),r=i.denom,n=("uscrt"==r&&(e=Math.floor(e/1e6),r="scrt"),s.push(""+e+r),"");switch(i.mode){case 0:n="Human only";break;case 1:n="AI only";break;case 2:n="Mixed"}s.push(""+n);d=c.rows;d[a+2-u]=s,c.setData(d)}}})}exports.Timer=Timer,exports.show_alert=show_alert,exports.get_input=get_input,exports.capacity_by_pool_id=capacity_by_pool_id,exports.sleep=sleep,exports.exit=exit,exports.translate_card=translate_card,exports.generate_header=generate_header,exports.generate_table=generate_table,exports.validate_card=validate_card,exports.generate_pool_table=generate_pool_table;